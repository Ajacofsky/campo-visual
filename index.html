import streamlit as st
import cv2
import numpy as np
from streamlit_image_coordinates import streamlit_image_coordinates

st.set_page_config(layout="wide", page_title="Peritaje Pro - Calibraci칩n Manual")

# Gesti칩n de estado persistente
if "centro" not in st.session_state: st.session_state.centro = None
if "x60" not in st.session_state: st.session_state.x60 = None
if "y60" not in st.session_state: st.session_state.y60 = None

def reset_all():
    st.session_state.centro = None
    st.session_state.x60 = None
    st.session_state.y60 = None

img_file = st.sidebar.file_uploader("Subir Imagen", type=['jpg', 'png', 'jpeg'])
st.sidebar.button("游댃 Reiniciar Todo", on_click=reset_all)

if img_file is not None:
    file_bytes = np.asarray(bytearray(img_file.read()), dtype=np.uint8)
    img_orig = cv2.imdecode(file_bytes, 1)
    
    # Selector de paso activo
    paso = st.radio("Seleccion치 el paso a calibrar:", ["Centro", "Margen Derecho (60춿)", "Margen Superior (60춿)"], horizontal=True)
    
    # Captura de coordenadas
    val = streamlit_image_coordinates(img_orig, key="canvas")
    
    if val:
        coords = (val["x"], val["y"])
        if paso == "Centro": st.session_state.centro = coords
        if paso == "Margen Derecho (60춿)": st.session_state.x60 = coords
        if paso == "Margen Superior (60춿)": st.session_state.y60 = coords
        st.write(f"Coordenadas guardadas para {paso}: {coords}")

    # Visualizaci칩n de lo marcado
    img_viz = img_orig.copy()
    if st.session_state.centro: cv2.drawMarker(img_viz, st.session_state.centro, (255, 0, 0), cv2.MARKER_CROSS, 30, 3)
    if st.session_state.x60: cv2.drawMarker(img_viz, st.session_state.x60, (0, 255, 0), cv2.MARKER_CROSS, 30, 3)
    if st.session_state.y60: cv2.drawMarker(img_viz, st.session_state.y60, (0, 0, 255), cv2.MARKER_CROSS, 30, 2)
    
    st.image(cv2.cvtColor(img_viz, cv2.COLOR_BGR2RGB))

    # Bot칩n de Procesar solo si est치n los 3 puntos
    if st.session_state.centro and st.session_state.x60 and st.session_state.y60:
        if st.button("游 CALCULAR INCAPACIDAD"):
            st.success("Calculando...")
            # (Aqu칤 ir칤a el motor de detecci칩n de cuadrados sobre img_orig...)
else:
    st.info("Sub칤 la imagen para empezar.")
