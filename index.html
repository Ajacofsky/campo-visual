import streamlit as st
import cv2
import numpy as np

st.set_page_config(layout="wide", page_title="Correcci贸n Final")

# T铆tulo para confirmar que el c贸digo cambi贸
st.title(" Calibrador de Anillos ROJOS Equidistantes")

file = st.sidebar.file_uploader("Subir Campo Visual", type=['jpg', 'png', 'jpeg'])

if file:
    # 1. Cargar imagen original
    file_bytes = np.asarray(bytearray(file.read()), dtype=np.uint8)
    img = cv2.imdecode(file_bytes, 1)
    h, w = img.shape[:2]

    # 2. Controles con nombres NUEVOS (Si no ves estos nombres, no est谩s en el c贸digo nuevo)
    st.sidebar.header("锔 AJUSTE DE PRECISIN")
    centro_x = st.sidebar.slider("Posici贸n Centro X", 0, w, w // 2)
    centro_y = st.sidebar.slider("Posici贸n Centro Y", 0, h, h // 2)
    
    # Este es el slider clave para la equidistancia
    marca_60 = st.sidebar.slider("Llevar c铆rculo exterior a Marca 60掳", centro_x, w, centro_x + 200)

    # MATEMTICA: Calculamos el radio total y lo dividimos en 6 partes iguales
    distancia_total = float(marca_60 - centro_x)
    paso_10_grados = distancia_total / 6.0

    # 3. DIBUJO DIRECTO SOBRE LA IMAGEN
    # Usamos (0, 0, 255) que es ROJO PURO en OpenCV (BGR)
    img_dibujo = img.copy()
    
    for i in range(1, 7):
        radio_actual = int(i * paso_10_grados)
        # Dibujamos el anillo con grosor 5 para que sea imposible no verlo
        cv2.circle(img_dibujo, (centro_x, centro_y), radio_actual, (0, 0, 255), 5)
        
        # Etiqueta de grados
        cv2.putText(img_dibujo, f"{i*10} deg", (centro_x + radio_actual, centro_y - 10), 
                    cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)

    # Ejes en rojo
    cv2.line(img_dibujo, (centro_x, 0), (centro_x, h), (0, 0, 255), 2)
    cv2.line(img_dibujo, (0, centro_y), (w, centro_y), (0, 0, 255), 2)

    # 4. CONVERSIN DE COLOR Y MUESTRA
    # 隆CRTICO! Convertimos de BGR a RGB para que Streamlit NO lo muestre negro o azul
    img_rgb = cv2.cvtColor(img_dibujo, cv2.COLOR_BGR2RGB)
    
    st.image(img_rgb, use_container_width=True, caption="Si ves l铆neas rojas, la calibraci贸n es exitosa")
    
    st.sidebar.info(f"Cada anillo est谩 a {round(paso_10_grados, 2)}px del anterior.")

else:
    st.warning("Esperando imagen...")
