import streamlit as st
import base64
from PIL import Image
import io

st.set_page_config(layout="wide")
st.title("‚öñÔ∏è Calibraci√≥n Vectorial Absoluta")

file = st.sidebar.file_uploader("1. Subir Informe", type=['jpg', 'png', 'jpeg'])

if file:
    # --- PROCESAMIENTO DE IMAGEN ---
    img = Image.open(file)
    w, h = img.size
    
    # Convertimos la imagen a base64 para mostrarla en HTML
    buffered = io.BytesIO()
    img.save(buffered, format="JPEG")
    img_str = base64.b64encode(buffered.getvalue()).decode()

    # --- CONTROLES ---
    st.sidebar.header("üéØ Ajustes de Grilla")
    cx = st.sidebar.slider("Centro X", 0, w, w // 2)
    cy = st.sidebar.slider("Centro Y", 0, h, h // 2)
    
    # El usuario define el l√≠mite de 60 grados
    r60 = st.sidebar.slider("Radio hasta Marca 60¬∞", 10, w // 2, 200)
    
    # Matem√°tica: Paso equidistante
    paso = r60 / 6.0

    # --- GENERACI√ìN DE SVG (Capa Roja) ---
    # Creamos los 6 anillos y los ejes en c√≥digo de dibujo puro
    anillos_svg = ""
    for i in range(1, 7):
        radio = i * paso
        anillos_svg += f'<circle cx="{cx}" cy="{cy}" r="{radio}" stroke="red" stroke-width="4" fill="none" />'
        anillos_svg += f'<text x="{cx + radio}" y="{cy - 5}" fill="red" font-size="20" font-weight="bold">{i*10}¬∞</text>'

    # Ejes en rojo
    ejes_svg = f"""
        <line x1="{cx}" y1="0" x2="{cx}" y2="{h}" stroke="red" stroke-width="2" />
        <line x1="0" y1="{cy}" x2="{w}" y2="{cy}" stroke="red" stroke-width="2" />
    """

    # --- RENDERIZADO FINAL (Imagen + Grilla) ---
    html_code = f"""
    <div style="position: relative; width: 100%; height: auto;">
        <img src="data:image/jpeg;base64,{img_str}" style="width: 100%; height: auto; display: block;" />
        <svg viewBox="0 0 {w} {h}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
            {ejes_svg}
            {anillos_svg}
            <circle cx="{cx}" cy="{cy}" r="5" fill="red" />
        </svg>
    </div>
    """

    st.components.v1.html(html_code, height=800, scrolling=True)
    
    st.success(f"Grilla generada. Distancia entre marcas de 10¬∞: {round(paso, 2)} p√≠xeles.")

else:
    st.info("Sube una imagen para ver la grilla roja vectorial.")
