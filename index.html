import streamlit as st
import cv2
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(layout="wide")
st.title("丘뒲잺 Sistema de Peritaje - Calibraci칩n Vectorial")

file = st.sidebar.file_uploader("Subir Informe", type=['jpg', 'png', 'jpeg'])

if file:
    # 1. Cargar imagen y convertir a RGB (importante para que no cambien los colores)
    file_bytes = np.asarray(bytearray(file.read()), dtype=np.uint8)
    img = cv2.imdecode(file_bytes, 1)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    h, w, _ = img.shape

    # 2. Controles laterales
    st.sidebar.header("游꿢 Ajuste Manual")
    cx = st.sidebar.slider("Centro X", 0, w, w // 2)
    cy = st.sidebar.slider("Centro Y", 0, h, h // 2)
    
    # Este slider controla el radio total (Marca 60)
    radio_60 = st.sidebar.slider("Radio hasta la marca 60춿", 50, w // 2, 200)

    # 3. Crear el gr치fico con Matplotlib (Esto garantiza el color ROJO)
    fig, ax = plt.subplots(figsize=(12, 12))
    ax.imshow(img) # La imagen de fondo

    # MATEM츼TICA: Dibujamos 6 anillos equidistantes (10, 20, 30, 40, 50, 60)
    # El radio de cada uno es (Radio_60 / 6) * i
    paso = radio_60 / 6.0

    for i in range(1, 7):
        # Dibujamos c칤rculos ROJOS INTENSOS
        circulo = plt.Circle((cx, cy), i * paso, color='red', fill=False, linewidth=3.5)
        ax.add_patch(circulo)
        # Etiquetas de grado para que no haya duda
        ax.text(cx + (i * paso), cy, f"{i*10}춿", color='red', weight='bold', fontsize=12)

    # Dibujamos los ejes radiales cada 45 grados
    for ang in range(0, 360, 45):
        rad = np.radians(ang)
        ax.plot([cx, cx + radio_60 * np.cos(rad)], 
                [cy, cy + radio_60 * np.sin(rad)], 
                color='red', lw=1.5, linestyle='--')

    # Cruz del centro
    ax.plot(cx, cy, 'r+', markersize=25, markeredgewidth=4)

    # Configuraci칩n de visualizaci칩n
    ax.axis('off')
    plt.subplots_adjust(left=0, right=1, top=1, bottom=0)

    # 4. Mostrar en Streamlit
    st.pyplot(fig)

    st.success(f"Grilla calibrada: Cada anillo est치 separado por {round(paso, 2)} p칤xeles exactos.")
else:
    st.warning("Por favor, sub칤 la imagen para ver la grilla roja.")
