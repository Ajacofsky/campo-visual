import streamlit as st
import base64
from PIL import Image
import io

st.set_page_config(layout="wide")
st.title("游꿢 Calibraci칩n de Anillos Equidistantes (Rojo Ne칩n)")

# Forzar limpieza visual
st.sidebar.button("游댃 Refrescar Aplicaci칩n")

file = st.sidebar.file_uploader("1. Subir Informe", type=['jpg', 'png', 'jpeg'], key="subidor_unico")

if file:
    # 1. Cargar y procesar imagen
    img = Image.open(file).convert("RGB")
    w, h = img.size
    
    buffered = io.BytesIO()
    img.save(buffered, format="JPEG")
    img_str = base64.b64encode(buffered.getvalue()).decode()

    # 2. Sliders de precisi칩n
    st.sidebar.header("游늺 Par치metros de Escala")
    cx = st.sidebar.slider("Centro X", 0, w, w // 2, key="cx")
    cy = st.sidebar.slider("Centro Y", 0, h, h // 2, key="cy")
    
    # Este slider controla la posici칩n del anillo de 60춿
    # Al moverlo, los de 10, 20, 30, 40 y 50 se mueven proporcionalmente.
    x60_marca = st.sidebar.slider("Alinear con Marca 60춿 del papel", cx, w, cx + 200, key="x60")
    
    # MATEM츼TICA DE EQUIDISTANCIA ABSOLUTA
    distancia_al_60 = float(x60_marca - cx)
    unidad_10deg = distancia_al_60 / 6.0

    # 3. CONSTRUCCI칍N DE LA CAPA ROJA (SVG)
    # Usamos color Hexadecimal #FF0000 para evitar errores de interpretaci칩n
    capa_roja = ""
    
    # Dibujamos los 6 anillos (10춿 a 60춿)
    for i in range(1, 7):
        r = i * unidad_10deg
        # C칤rculos con borde rojo ne칩n muy grueso (5px)
        capa_roja += f'<circle cx="{cx}" cy="{cy}" r="{r}" stroke="#FF0000" stroke-width="5" fill="none" />'
        # Etiquetas de control
        capa_roja += f'<text x="{cx + r}" y="{cy - 10}" fill="#FF0000" font-size="24" font-weight="bold">{i*10}춿</text>'

    # Ejes principales en Rojo
    capa_roja += f'<line x1="{cx}" y1="0" x2="{cx}" y2="{h}" stroke="#FF0000" stroke-width="3" />'
    capa_roja += f'<line x1="0" y1="{cy}" x2="{w}" y2="{cy}" stroke="#FF0000" stroke-width="3" />'

    # 4. RENDERIZADO HTML (Imagen + SVG)
    html_display = f"""
    <div style="position: relative; border: 5px solid #FF0000;">
        <img src="data:image/jpeg;base64,{img_str}" style="width: 100%; height: auto; display: block;" />
        <svg viewBox="0 0 {w} {h}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
            {capa_roja}
            <circle cx="{cx}" cy="{cy}" r="8" fill="#FF0000" />
        </svg>
    </div>
    """

    st.components.v1.html(html_display, height=900, scrolling=True)
    
    st.sidebar.write(f"游댌 **Info de Escala:**")
    st.sidebar.write(f"Distancia entre marcas: {round(unidad_10deg, 1)} px")

else:
    st.info("Sub칤 la imagen para ver los anillos rojos.")
