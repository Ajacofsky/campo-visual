import streamlit as st
import cv2
import numpy as np
from streamlit_image_coordinates import streamlit_image_coordinates

st.set_page_config(layout="wide", page_title="Peritaje Pro V17")

# --- MEMORIA DE ESTADO ---
if "centro" not in st.session_state: st.session_state.centro = None
if "punto60" not in st.session_state: st.session_state.punto60 = None
if "fijar_centro" not in st.session_state: st.session_state.fijar_centro = False

st.title("‚öñÔ∏è Analizador de Incapacidad")

img_file = st.sidebar.file_uploader("Subir Informe", type=['jpg', 'png', 'jpeg'])

if img_file:
    file_bytes = np.asarray(bytearray(img_file.read()), dtype=np.uint8)
    img_orig = cv2.imdecode(file_bytes, 1)
    h, w = img_orig.shape[:2]

    # --- L√ìGICA DE INTERFAZ ---
    if not st.session_state.fijar_centro:
        st.subheader("üéØ PASO 1: Ubic√° el Centro (0,0)")
        st.info("Hac√© clic en la cruz central. Cuando est√© bien ubicado, presion√° el bot√≥n 'FIJAR CENTRO'.")
    else:
        st.subheader("‚û°Ô∏è PASO 2: Ubic√° la marca de 60¬∞ (Eje X)")
        st.warning("El centro est√° bloqueado. Ahora hac√© clic donde dice '60' en el eje horizontal.")

    # Dibujar marcas actuales
    img_draw = img_orig.copy()
    if st.session_state.centro:
        cv2.drawMarker(img_draw, st.session_state.centro, (255, 0, 0), cv2.MARKER_CROSS, 40, 2)
    if st.session_state.punto60:
        cv2.drawMarker(img_draw, st.session_state.punto60, (0, 0, 255), cv2.MARKER_TACK, 30, 2)

    # CAPTURA DE CLIC
    # Cambiamos la key para que el componente se refresque al cambiar de paso
    k = "click_centro" if not st.session_state.fijar_centro else "click_60"
    coords = streamlit_image_coordinates(img_draw, key=k)

    if coords:
        p = (coords["x"], coords["y"])
        if not st.session_state.fijar_centro:
            st.session_state.centro = p # El clic mueve el centro
        else:
            st.session_state.punto60 = p # El clic mueve la marca de 60

    # --- BOTONES DE CONTROL ---
    col1, col2 = st.columns(2)
    with col1:
        if not st.session_state.fijar_centro:
            if st.button("‚úÖ FIJAR CENTRO"):
                st.session_state.fijar_centro = True
                st.rerun()
        else:
            if st.button("üîÑ CORREGIR CENTRO"):
                st.session_state.fijar_centro = False
                st.session_state.punto60 = None
                st.rerun()
    
    with col2:
        if st.sidebar.button("üóëÔ∏è Reset Total"):
            st.session_state.centro = None
            st.session_state.punto60 = None
            st.session_state.fijar_centro = False
            st.rerun()

    # --- PROCESAMIENTO FINAL (Solo si ambos puntos existen) ---
    if st.session_state.centro and st.session_state.punto60:
        cx, cy = st.session_state.centro
        x60, y60 = st.session_state.punto60
        
        # Tal como pediste: dividir la distancia al 60 por 6 para tener pasos de 10
        dist_total = np.sqrt((x60-cx)**2 + (y60-cy)**2)
        px_10 = dist_total / 6
        
        res = img_orig.copy()
        
        # Dibujar los anillos seg√∫n tu Word (4 anillos hasta 40¬∞) 
        for i in range(1, 5):
            radio = int(i * px_10)
            cv2.circle(res, (cx, cy), radio, (0, 255, 0), 2)
            cv2.putText(res, f"{i*10}g", (cx + radio, cy - 5), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0,255,0), 1)

        st.image(cv2.cvtColor(res, cv2.COLOR_BGR2RGB), caption="Previsualizaci√≥n de Anillos (10¬∞-40¬∞)")
        st.success(f"Escala calculada: {round(px_10, 2)} p√≠xeles por cada 10 grados.")

else:
    st.info("Sub√≠ la imagen para comenzar la calibraci√≥n.")
