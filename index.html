import streamlit as st
import numpy as np
import cv2
from matplotlib import pyplot as plt

st.set_page_config(layout="wide")

st.sidebar.title("Configuración de Grilla")
file = st.sidebar.file_uploader("Subir informe", type=['jpg', 'png', 'jpeg'])

if file:
    # 1. Cargar imagen
    file_bytes = np.asarray(bytearray(file.read()), dtype=np.uint8)
    img = cv2.imdecode(file_bytes, 1)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB) # Asegurar formato de color correcto
    h, w, _ = img.shape

    # 2. Sliders de control
    cx = st.sidebar.slider("Centro X", 0, w, w // 2)
    cy = st.sidebar.slider("Centro Y", 0, h, h // 2)
    # Este slider define la distancia al 60. 
    # El programa dividirá automáticamente por 6 para crear los 10, 20, 30, 40, 50.
    radio_60 = st.sidebar.slider("Radio hasta Marca 60°", 10, w // 2, 200)

    # 3. Dibujo con Matplotlib (Esto fuerza el color ROJO)
    fig, ax = plt.subplots(figsize=(10, 10))
    ax.imshow(img) # Pone la foto de fondo
    
    # Calculamos el paso exacto para que sean equidistantes
    paso = radio_60 / 6.0

    # Dibujamos los 6 anillos en ROJO PURO
    for i in range(1, 7):
        r = i * paso
        # 'color="red"' en Matplotlib es un comando absoluto, no depende de la imagen
        circulo = plt.Circle((cx, cy), r, color='red', fill=False, linewidth=3)
        ax.add_patch(circulo)
        
        # Agregamos el número para verificar la marca
        ax.text(cx + r, cy, f"{i*10}", color='red', fontsize=10, fontweight='bold')

    # Dibujamos los ejes en rojo
    ax.axhline(cy, color='red', linewidth=1, alpha=0.5)
    ax.axvline(cx, color='red', linewidth=1, alpha=0.5)

    ax.axis('off') # Quitamos los números de los bordes para ver solo el informe
    
    # 4. Mostrar resultado
    st.pyplot(fig)
    
    st.info(f"Cada marca de 10° está a una distancia de {round(paso, 2)} píxeles.")

else:
    st.write("Por favor, sube una imagen en el menú lateral.")
