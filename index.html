import streamlit as st
import numpy as np
import cv2
from matplotlib import pyplot as plt

st.set_page_config(layout="wide", page_title="Peritaje Pro V30")
st.title("丘뒲잺 Calibraci칩n por Gr치fico de Precisi칩n (Matplotlib)")

img_file = st.sidebar.file_uploader("Subir Informe", type=['jpg', 'png', 'jpeg'])

if img_file:
    # 1. CARGA DE IMAGEN
    file_bytes = np.asarray(bytearray(img_file.read()), dtype=np.uint8)
    img = cv2.imdecode(file_bytes, 1)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB) # Convertimos a RGB para Matplotlib
    h, w, _ = img.shape

    # 2. CONTROLES DE POSICI칍N (Basados en proporci칩n 0-100 para evitar errores de p칤xel)
    st.sidebar.header("游꿢 1. Ubicar Centro")
    cx = st.sidebar.slider("Centro Horizontal %", 0, 100, 50) / 100 * w
    cy = st.sidebar.slider("Centro Vertical %", 0, 100, 50) / 100 * h

    st.sidebar.header("游늺 2. Ajustar Marca 60춿")
    # Movemos este slider hasta que el c칤rculo exterior pise el '60' del papel
    ancla_60 = st.sidebar.slider("Radio hasta Marca 60춿", 10, w//2, 200)

    # MATEM츼TICA PURA: Dividimos el radio del 60 en 6 partes iguales
    radio_paso = ancla_60 / 6.0

    # 3. CREACI칍N DEL GR츼FICO (Nueva Perspectiva)
    fig, ax = plt.subplots(figsize=(10, 10))
    
    # Mostramos la imagen de fondo
    ax.imshow(img)

    # Dibujamos los anillos CON MATPLOTLIB (L칤neas vectoriales, no p칤xeles)
    # Dibujamos 6 anillos equidistantes
    for i in range(1, 7):
        radio = i * radio_paso
        circulo = plt.Circle((cx, cy), radio, color='red', fill=False, linewidth=3, alpha=0.9)
        ax.add_patch(circulo)
        # Etiqueta de grado
        ax.text(cx + radio, cy, f"{i*10}춿", color='red', fontsize=10, fontweight='bold')

    # Dibujamos los ejes radiales (cada 45춿)
    for angulo in range(0, 360, 45):
        rad = np.radians(angulo)
        x_fin = cx + (ancla_60) * np.cos(rad)
        y_fin = cy + (ancla_60) * np.sin(rad)
        ax.plot([cx, x_fin], [cy, y_fin], color='red', lw=1.5, alpha=0.7)

    # Marca del centro
    ax.plot(cx, cy, 'r+', markersize=20, markeredgewidth=3)

    # Est칠tica del gr치fico
    ax.axis('off') # Ocultar ejes de coordenadas de la foto
    plt.tight_layout(pad=0)

    # 4. MOSTRAR EN STREAMLIT
    st.pyplot(fig)
    
    st.success(f"Equidistancia: {round(radio_paso, 2)} unidades entre anillos.")

else:
    st.info("Sub칤 la imagen para generar la grilla vectorial roja.")
